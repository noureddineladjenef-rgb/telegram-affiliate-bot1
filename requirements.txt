import os
from telegram import Bot, Update, ParseMode
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext

# Ø¬Ù„Ø¨ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ¦Ø©
BOT_TOKEN = os.getenv("BOT_TOKEN", "6986501751:AAF0Ra1lpXvdob21IQ9QORLCpclXPUPFyes")
AFFILIATE_ID = os.getenv("AFFILIATE_ID", "503368")

bot = Bot(token=BOT_TOKEN)

# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
FILES = {
    "bot": "bot.py",
    "manual": "guide.pdf"
}

def start(update: Update, context: CallbackContext):
    message = (
        "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ! ğŸ‘‹\n\n"
        "Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ù…Ù†ØªØ¬ Ù…Ù† AliExpress ÙˆØ³Ø£Ø±Ø³Ù„ Ù„Ùƒ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙ‡ Ù…Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø±Ø§Ø¡.\n"
        "Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª:\n"
        "/getfile <Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù> - Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ù.\n"
        "/help - Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©."
    )
    update.message.reply_text(message)

def help_command(update: Update, context: CallbackContext):
    message = (
        "Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…ØªØ§Ø­Ø©:\n"
        "/start - ØªØ±Ø­ÙŠØ¨ Ø¨Ø§Ù„Ø¨ÙˆØª.\n"
        "/getfile <Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù> - Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.\n"
        "Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· AliExpress Ù„Ø£ÙŠ Ù…Ù†ØªØ¬ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ±Ø§Ø¨Ø· Ø§Ù„Ø£ÙÙ„ÙŠÙŠØª."
    )
    update.message.reply_text(message)

def get_file(update: Update, context: CallbackContext):
    if not context.args:
        update.message.reply_text("âŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø±.")
        return
    key = context.args[0].lower()
    if key in FILES:
        path = FILES[key]
        try:
            with open(path, "rb") as f:
                update.message.reply_document(f, filename=path, caption=f"ğŸ“„ Ø§Ù„Ù…Ù„Ù: {path}")
        except FileNotFoundError:
            update.message.reply_text("âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±.")
    else:
        update.message.reply_text("âŒ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ØªØ§Ø­.")

def handle_message(update: Update, context: CallbackContext):
    url = update.message.text.strip()
    if "aliexpress.com" not in url:
        update.message.reply_text("âŒ Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­ Ù…Ù† AliExpress Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø­Ø¯ Ø§Ù„Ø£ÙˆØ§Ù…Ø±.")
        return
    try:
        product_id = url.split(".html")[0].split("/")[-1].split(".")[-1]
        # Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ© ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø· API Ù„Ø§Ø­Ù‚Ù‹Ø§
        product_name = "Ù‡Ø§ØªÙ OnePlus Ace5 Ø§Ù„Ù…Ø­Ù…ÙˆÙ„"
        product_price = "435.60$"
        product_discount = "10%"
        product_image = "https://ae01.alicdn.com/kf/SampleImage.jpg"
        affiliate_url = f"{url}?aff_fcid={AFFILIATE_ID}&aff_platform=default&dp=c"
        message = (
            f"ğŸ“¦ <b>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</b> {product_name}\n"
            f"ğŸ’° <b>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:</b> {product_price}\n"
            f"ğŸ·ï¸ <b>Ø§Ù„Ø®ØµÙ…:</b> {product_discount}\n"
            f"ğŸ”— <b>Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø±Ø§Ø¡:</b> [Ø§Ø¶ØºØ· Ù‡Ù†Ø§]({affiliate_url})"
        )
        bot.send_photo(chat_id=update.message.chat_id, photo=product_image, caption=message, parse_mode=ParseMode.HTML)
    except Exception as e:
        update.message.reply_text(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§Ø¨Ø·.\n{e}")

def main():
    updater = Updater(BOT_TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("help", help_command))
    dp.add_handler(CommandHandler("getfile", get_file))
    dp.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_message))

    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
